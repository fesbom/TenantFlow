**Assunto:** Implementar Funcionalidade de Foto do Paciente com Lógica de Ambiente (Desenvolvimento vs. Produção)

**Prompt:**

Aja como um desenvolvedor full-stack sênior. A sua tarefa é implementar uma funcionalidade avançada e totalmente integrada para a gestão da foto de perfil dos pacientes, resolvendo o problema de perda de ficheiros em produção (ambiente efémero do Replit).

**Instruções de Execução:**
* Foque-se apenas na implementação do código conforme os requisitos abaixo. **Não execute testes funcionais**, pois estes serão realizados por mim.
* Ao me retornar o código modificado, forneça sempre o **ficheiro completo** de cada ficheiro alterado.

---

### **User Story:**

Como profissional da clínica, eu quero poder **adicionar ou capturar** uma foto no perfil de cada paciente, **ajustar o enquadramento** (4x3), e ter a certeza de que a foto **não desaparecerá** quando a aplicação reiniciar. Quero ver esta foto em todos os pontos-chave do sistema.

### **Requisitos Técnicos Detalhados:**

**1. Backend (Banco de Dados e API):**
* **Banco de Dados:** Garanta que a tabela `Patient` possui a coluna `photoUrl` (tipo: `String`, opcional/nullable).
* **APIs de Consulta:** **(Reforço Crítico)** Modifique todos os endpoints que retornam dados de pacientes (`GET /api/patients`, `GET /api/appointments`, e **`GET /api/dashboard/birthday-patients`**) para que **incluam o campo `photoUrl`** nos dados retornados.
* **API de Upload (`POST /api/patients/:id/photo`):** Esta rota deve agora ter uma lógica condicional baseada no ambiente:
    * **Lógica de Detenção de Ambiente:** Use `process.env.NODE_ENV === 'production'` para verificar se está a correr no deployment.
    * **Se for Produção (`production`):**
        1.  Receba a imagem.
        2.  Faça o upload do ficheiro (Blob) diretamente para o **Replit Buckets**.
        3.  Obtenha a **URL pública e permanente** do Bucket.
        4.  Salve esta URL completa no campo `photoUrl` do paciente.
    * **Se for Desenvolvimento (`development`):**
        1.  Continue a usar o `multer` para salvar o ficheiro na pasta local `/uploads`.
        2.  Salve o caminho relativo (ex: `/uploads/foto.jpg`) no campo `photoUrl` do paciente.
* **API de Remoção de Foto:** Ao remover uma foto (atualizando `photoUrl` para `null` no `PUT /api/patients/:id`), adicione a lógica para apagar o ficheiro correspondente, seja ele do Replit Bucket (em produção) ou da pasta `/uploads` (em desenvolvimento).

**2. Frontend (Captura e Gestão da Foto - `PhotoUpload.tsx`):**
* **Componente Principal:** Exiba a foto atual. Se não houver, mostre um ícone padrão. Ao clicar, ofereça as opções:
    1.  **"Carregar Ficheiro"**: Abre o seletor de ficheiros.
    2.  **"Tirar Foto (Webcam/Câmera)"**: Ativa a câmera do dispositivo com um botão "Capturar".
    3.  **"Remover Foto"**: Apaga a foto atual (deve chamar a API para remover a foto).
* **Modal de Recorte (Crop):** Após carregar ou capturar uma foto, exiba um modal com a biblioteca **`Cropper.js`**. (Não se esqueça de importar o `cropper.css` no `index.html` via CDN, como fizemos anteriormente).
    * **Configuração:** Configure o `Cropper.js` para forçar uma proporção de **4:3**.
* **Lógica de Salvamento:** Envie **apenas a imagem já recortada** para a API de upload (`POST /api/patients/:id/photo`). O frontend não precisa de saber se o backend vai salvar no Bucket ou localmente.

**3. Frontend (Exibição da Foto no Sistema - Requisito Consolidado):**
A foto do paciente (`photoUrl`) deve ser exibida nos seguintes locais:
* **No Dashboard (Aniversariantes):** Na lista de aniversariantes do dia, exiba a miniatura (avatar circular) da foto ao lado do nome de cada paciente.
* **Na Lista de Pacientes:** Adicione uma coluna no início da tabela de pacientes para exibir a miniatura (avatar circular) da foto.
* **No Agendamento (Calendário):** No "pop-up" ou detalhe do evento no calendário, exiba a miniatura da foto ao lado do nome do paciente.
* **Na Seleção de Paciente para Tratamento:** No formulário de criação de um novo tratamento, quando um paciente for selecionado, exiba a sua foto e nome.

**Diretrizes de Qualidade e Segurança:**
* **Código Limpo:** Crie um componente React reutilizável para a lógica de captura e recorte.
* **Segurança:** Mantenha as validações de tipo de ficheiro e tamanho máximo (ex: 5MB) no backend antes de fazer o upload, independentemente do destino (Bucket ou disco).